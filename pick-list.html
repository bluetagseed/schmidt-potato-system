<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick List Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        .header {
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #f46b45;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #f46b45;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f46b45;
            box-shadow: 0 0 0 3px rgba(244, 107, 69, 0.1);
        }
        
        input[readonly] {
            background: #f5f5f5;
            color: #666;
        }
        
        .product-card {
            background: #fff5f2;
            border: 2px solid #f46b45;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .product-number {
            font-size: 1.3em;
            font-weight: bold;
            color: #f46b45;
        }
        
        .remove-product {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .remove-product:hover {
            background: #cc0000;
        }
        
        .total-bags-highlight {
            background: #ffeb3b;
            border: 3px solid #f4b945;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .total-bags-highlight label {
            font-size: 1.1em;
            color: #f46b45;
        }
        
        .total-bags-highlight input {
            font-size: 1.2em;
            font-weight: bold;
            border: 2px solid #f46b45;
        }
        
        .add-product-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .add-product-btn:hover {
            background: #45a049;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(244, 107, 69, 0.3);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .counter-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‹ Pick List Generator</h1>
            <p>Schmidt Potato - Warehouse Picking</p>
        </div>
        
        <div class="form-container">
            <form id="pickListForm" onsubmit="handleSubmit(event)">
                
                <!-- Order Information Section -->
                <div class="section-title">ðŸ“¦ Order Information</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pickListID">Pick List ID (Auto-Generated)</label>
                        <input type="text" id="pickListID" readonly>
                        <div class="counter-info">Next: <span id="nextPickListID"></span></div>
                    </div>
                    <div class="form-group">
                        <label for="orderDate">Order Date *</label>
                        <input type="date" id="orderDate" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="customerSelect">Select Customer *</label>
                        <select id="customerSelect" required>
                            <option value="">-- Select Customer --</option>
                            <option value="sysco">Sysco Foods - Minneapolis</option>
                            <option value="usfoods">US Foods - Fargo</option>
                            <option value="gordon">Gordon Food Service - Duluth</option>
                            <option value="pfg">Performance Food Group - St. Paul</option>
                            <option value="reinhart">Reinhart Foodservice - Moorhead</option>
                            <option value="other">Other (Type Below)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="poNumber">PO Number *</label>
                        <input type="text" id="poNumber" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="shipDate">Ship Date *</label>
                        <input type="date" id="shipDate" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryDate">Delivery Date</label>
                        <input type="date" id="deliveryDate">
                    </div>
                </div>
                
                <!-- Products Section -->
                <div class="section-title">ðŸ¥” Products to Pick</div>
                
                <div id="productsContainer">
                    <!-- Product cards will be added here -->
                </div>
                
                <button type="button" class="add-product-btn" onclick="addProduct()">âž• Add Another Product</button>
                
                <!-- Summary Section -->
                <div class="section-title">ðŸ“Š Order Summary</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalPallets">Total Pallets</label>
                        <input type="number" id="totalPallets" readonly value="0">
                    </div>
                    <div class="form-group">
                        <label for="totalBags">Total Bags</label>
                        <input type="number" id="totalBags" readonly value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalWeight">Total Weight (LBS)</label>
                        <input type="number" id="totalWeight" readonly value="0">
                    </div>
                    <div class="form-group">
                        <label for="assignedPalletIDs">Assigned Pallet IDs</label>
                        <input type="text" id="assignedPalletIDs" readonly placeholder="Will show after calculation">
                    </div>
                </div>
                
                <!-- Buttons -->
                <div class="button-group">
                    <button type="button" class="btn-secondary" onclick="resetForm()">ðŸ”„ Reset Form</button>
                    <button type="submit" class="btn-primary">ðŸ“¥ Generate Pick List</button>
                </div>
                
            </form>
        </div>
    </div>

    <script>
        let productCount = 0;
        let products = [];
        
        // Customer database
        const customers = {
            'sysco': 'Sysco Foods - Minneapolis',
            'usfoods': 'US Foods - Fargo',
            'gordon': 'Gordon Food Service - Duluth',
            'pfg': 'Performance Food Group - St. Paul',
            'reinhart': 'Reinhart Foodservice - Moorhead'
        };
        
        // Variety codes
        const varietyCodes = {
            'Russet Burbank': 'RB',
            'Red Pontiac': 'RP',
            'Yukon Gold': 'YG',
            'Kennebec': 'KE'
        };
        
        // Get Pick List counter
        function getPickListCounter() {
            var counter = localStorage.getItem('pickListCounter');
            if (!counter) {
                counter = 1;
                localStorage.setItem('pickListCounter', counter);
            }
            return parseInt(counter);
        }
        
        // Set Pick List counter
        function setPickListCounter(value) {
            localStorage.setItem('pickListCounter', value);
        }
        
        // Get Pallet counter
        function getPalletCounter() {
            var counter = localStorage.getItem('palletCounter');
            if (!counter) {
                counter = 1;
                localStorage.setItem('palletCounter', counter);
            }
            return parseInt(counter);
        }
        
        // Set Pallet counter
        function setPalletCounter(value) {
            localStorage.setItem('palletCounter', value);
        }
        
        // Generate Pick List ID
        function generatePickListID() {
            var counter = getPickListCounter();
            var pickListID = 'PL-' + String(counter).padStart(3, '0');
            document.getElementById('pickListID').value = pickListID;
            
            var nextCounter = counter + 1;
            document.getElementById('nextPickListID').textContent = 'PL-' + String(nextCounter).padStart(3, '0');
        }
        
        // Handle customer selection
        document.getElementById('customerSelect').addEventListener('change', function() {
            var selected = this.value;
            if (selected && selected !== 'other' && customers[selected]) {
                document.getElementById('customerName').value = customers[selected];
            } else if (selected === 'other') {
                document.getElementById('customerName').value = '';
                document.getElementById('customerName').focus();
            }
        });
        
        // Add product
        function addProduct() {
            productCount++;
            
            var productHTML = '<div class="product-card" id="product-' + productCount + '" data-product-num="' + productCount + '">' +
                '<div class="product-header">' +
                    '<span class="product-number">Product Entry ' + productCount + '</span>' +
                    '<button type="button" class="remove-product" onclick="removeProduct(' + productCount + ')">âœ• Remove</button>' +
                '</div>' +
                '<div class="total-bags-highlight">' +
                    '<div class="form-group">' +
                        '<label>ðŸ“¦ TOTAL BAGS NEEDED *</label>' +
                        '<input type="number" class="product-total-bags" min="1" placeholder="Enter total bags" required oninput="calculateSummary()">' +
                    '</div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label>Variety *</label>' +
                        '<select class="product-variety" required onchange="calculateSummary()">' +
                            '<option value="">Select Variety</option>' +
                            '<option value="Russet Burbank">Russet Burbank</option>' +
                            '<option value="Red Pontiac">Red Pontiac</option>' +
                            '<option value="Yukon Gold">Yukon Gold</option>' +
                            '<option value="Kennebec">Kennebec</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label>Pack Weight *</label>' +
                        '<select class="product-weight" required onchange="calculateSummary()">' +
                            '<option value="">Select Weight</option>' +
                            '<option value="3">3 LBS</option>' +
                            '<option value="4">4 LBS</option>' +
                            '<option value="5">5 LBS</option>' +
                            '<option value="10">10 LBS</option>' +
                            '<option value="25">25 LBS</option>' +
                            '<option value="50" selected>50 LBS</option>' +
                            '<option value="100">100 LBS</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label>Grade *</label>' +
                        '<select class="product-grade" required onchange="calculateSummary()">' +
                            '<option value="">Select Grade</option>' +
                            '<option value="Blue Tag Size A" selected>Blue Tag Size A</option>' +
                            '<option value="Blue Tag Size B">Blue Tag Size B</option>' +
                            '<option value="Red Tag Premium">Red Tag Premium</option>' +
                            '<option value="Standard">Standard</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label>Bags per Pallet (default 40)</label>' +
                        '<input type="number" class="product-bags-per-pallet" min="1" value="40" required oninput="calculateSummary()">' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            document.getElementById('productsContainer').insertAdjacentHTML('beforeend', productHTML);
            
            products.push(productCount);
            calculateSummary();
        }
        
        // Remove product
        function removeProduct(productNum) {
            var productCard = document.getElementById('product-' + productNum);
            if (productCard) {
                productCard.remove();
                var index = products.indexOf(productNum);
                if (index > -1) {
                    products.splice(index, 1);
                }
                calculateSummary();
            }
        }
        
        // Calculate summary with smart merge
        function calculateSummary() {
            var mergedGroups = {};
            
            // Group products by variety + weight + grade
            products.forEach(function(productNum) {
                var productCard = document.getElementById('product-' + productNum);
                if (productCard) {
                    var variety = productCard.querySelector('.product-variety').value;
                    var weight = productCard.querySelector('.product-weight').value;
                    var grade = productCard.querySelector('.product-grade').value;
                    var totalBags = parseInt(productCard.querySelector('.product-total-bags').value) || 0;
                    var customBagsPerPallet = parseInt(productCard.querySelector('.product-bags-per-pallet').value) || 40;
                    
                    if (variety && weight && grade && totalBags > 0) {
                        var groupKey = variety + '|' + weight + '|' + grade + '|' + customBagsPerPallet;
                        
                        if (!mergedGroups[groupKey]) {
                            mergedGroups[groupKey] = {
                                variety: variety,
                                weight: weight,
                                grade: grade,
                                bagsPerPallet: customBagsPerPallet,
                                totalBags: 0,
                                sources: []
                            };
                        }
                        
                        mergedGroups[groupKey].totalBags += totalBags;
                        mergedGroups[groupKey].sources.push(productNum);
                    }
                }
            });
            
            // Calculate totals
            var currentPalletCounter = getPalletCounter();
            var palletIndex = 0;
            var totalPallets = 0;
            var totalBags = 0;
            var totalWeight = 0;
            var allPalletIDs = [];
            
            for (var groupKey in mergedGroups) {
                var group = mergedGroups[groupKey];
                var numPallets = Math.ceil(group.totalBags / group.bagsPerPallet);
                totalPallets += numPallets;
                totalBags += group.totalBags;
                totalWeight += (group.totalBags * parseInt(group.weight));
                
                for (var i = 0; i < numPallets; i++) {
                    var palletID = 'P-' + String(currentPalletCounter + palletIndex).padStart(3, '0');
                    allPalletIDs.push(palletID);
                    palletIndex++;
                }
            }
            
            document.getElementById('totalPallets').value = totalPallets;
            document.getElementById('totalBags').value = totalBags;
            document.getElementById('totalWeight').value = totalWeight;
            document.getElementById('assignedPalletIDs').value = allPalletIDs.join(', ');
        }
        
        // Initialize form
        function initializeForm() {
            try {
                var today = new Date();
                var year = today.getFullYear();
                var month = String(today.getMonth() + 1).padStart(2, '0');
                var day = String(today.getDate()).padStart(2, '0');
                var dateString = year + '-' + month + '-' + day;
                
                document.getElementById('orderDate').value = dateString;
                document.getElementById('shipDate').value = dateString;
                
                generatePickListID();
                
                // Add first product automatically
                addProduct();
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }
        
        // Handle form submission
        function handleSubmit(event) {
            event.preventDefault();
            
            // Get form data
            var pickListID = document.getElementById('pickListID').value;
            var orderDate = document.getElementById('orderDate').value;
            var customerName = document.getElementById('customerName').value;
            var poNumber = document.getElementById('poNumber').value;
            var shipDate = document.getElementById('shipDate').value;
            var deliveryDate = document.getElementById('deliveryDate').value;
            
            // SMART MERGE: Group products by variety|weight|grade|bagsPerPallet FIRST
            var mergedGroups = {};
            
            products.forEach(function(productNum) {
                var productCard = document.getElementById('product-' + productNum);
                if (productCard) {
                    var variety = productCard.querySelector('.product-variety').value;
                    var weight = productCard.querySelector('.product-weight').value;
                    var grade = productCard.querySelector('.product-grade').value;
                    var totalBags = parseInt(productCard.querySelector('.product-total-bags').value) || 0;
                    var customBagsPerPallet = parseInt(productCard.querySelector('.product-bags-per-pallet').value) || 40;
                    
                    if (variety && weight && grade && totalBags > 0) {
                        // Create unique key for grouping
                        var groupKey = variety + '|' + weight + '|' + grade + '|' + customBagsPerPallet;
                        
                        if (!mergedGroups[groupKey]) {
                            mergedGroups[groupKey] = {
                                variety: variety,
                                weight: weight,
                                grade: grade,
                                bagsPerPallet: customBagsPerPallet,
                                totalBags: 0
                            };
                        }
                        
                        // Merge bags from matching entries
                        mergedGroups[groupKey].totalBags += totalBags;
                    }
                }
            });
            
            // Generate pallets from MERGED groups
            var currentPalletCounter = getPalletCounter();
            var palletIndex = 0;
            var allPallets = [];
            var csvData = [];
            
            // Add CSV header
            csvData.push(['Pallet ID', 'Variety', 'Weight (LBS)', 'Grade', 'Bags', 'Total Weight']);
            
            // Process each merged group
            for (var groupKey in mergedGroups) {
                var group = mergedGroups[groupKey];
                var numPallets = Math.ceil(group.totalBags / group.bagsPerPallet);
                var remainingBags = group.totalBags;
                
                // Create pallets for this group
                for (var i = 0; i < numPallets; i++) {
                    var bagsOnThisPallet = Math.min(group.bagsPerPallet, remainingBags);
                    var palletID = 'P-' + String(currentPalletCounter + palletIndex).padStart(3, '0');
                    var palletWeight = bagsOnThisPallet * parseInt(group.weight);
                    
                    var palletData = {
                        palletID: palletID,
                        pickListID: pickListID,
                        variety: group.variety,
                        weight: group.weight,
                        grade: group.grade,
                        bags: bagsOnThisPallet,
                        totalWeight: palletWeight,
                        customerName: customerName,
                        poNumber: poNumber,
                        shipDate: shipDate
                    };
                    
                    allPallets.push(palletData);
                    csvData.push([palletID, group.variety, group.weight, group.grade, bagsOnThisPallet, palletWeight]);
                    
                    remainingBags -= bagsOnThisPallet;
                    palletIndex++;
                }
            }
            
            // Update pallet counter
            setPalletCounter(currentPalletCounter + palletIndex);
            
            // Save pick list data
            var pickListData = {
                pickListID: pickListID,
                orderDate: orderDate,
                customerName: customerName,
                poNumber: poNumber,
                shipDate: shipDate,
                deliveryDate: deliveryDate,
                totalPallets: allPallets.length,
                totalBags: parseInt(document.getElementById('totalBags').value),
                totalWeight: parseInt(document.getElementById('totalWeight').value),
                pallets: allPallets
            };
            
            // Save to localStorage (would integrate with DataHub if available)
            try {
                var pickLists = JSON.parse(localStorage.getItem('pickLists') || '[]');
                pickLists.push(pickListData);
                localStorage.setItem('pickLists', JSON.stringify(pickLists));
                
                // Save individual pallets
                var existingPallets = JSON.parse(localStorage.getItem('pallets') || '[]');
                allPallets.forEach(function(pallet) {
                    existingPallets.push(pallet);
                });
                localStorage.setItem('pallets', JSON.stringify(existingPallets));
            } catch (error) {
                console.error('Error saving data:', error);
            }
            
            // Increment pick list counter
            var currentPickListCounter = getPickListCounter();
            setPickListCounter(currentPickListCounter + 1);
            
            // Generate CSV export
            generateCSVExport(csvData, pickListID);
            
            // Show success message
            alert('âœ… Pick List ' + pickListID + ' generated successfully!\n\n' +
                  'Total Pallets: ' + allPallets.length + '\n' +
                  'Total Bags: ' + pickListData.totalBags + '\n' +
                  'Total Weight: ' + pickListData.totalWeight + ' LBS\n\n' +
                  'CSV file has been downloaded.');
            
            // Reset form for next order
            resetForm();
            
            return false;
        }
        
        // Generate CSV export
        function generateCSVExport(csvData, pickListID) {
            var csvContent = csvData.map(function(row) {
                return row.join(',');
            }).join('\n');
            
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'picklist_' + pickListID + '_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForm);
        } else {
            initializeForm();
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('pickListForm').reset();
            document.getElementById('productsContainer').innerHTML = '';
            productCount = 0;
            products = [];
            
            var today = new Date();
            var year = today.getFullYear();
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var day = String(today.getDate()).padStart(2, '0');
            var dateString = year + '-' + month + '-' + day;
            
            document.getElementById('orderDate').value = dateString;
            document.getElementById('shipDate').value = dateString;
            
            generatePickListID();
            addProduct();
            calculateSummary();
        }
    </script>
</body>
</html>
