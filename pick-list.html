<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick List Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        .header {
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #f46b45;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #f46b45;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f46b45;
            box-shadow: 0 0 0 3px rgba(244, 107, 69, 0.1);
        }
        
        input[readonly] {
            background: #f5f5f5;
            color: #666;
        }
        
        .product-card {
            background: #fff5f2;
            border: 2px solid #f46b45;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .product-number {
            font-size: 1.3em;
            font-weight: bold;
            color: #f46b45;
        }
        
        .remove-product {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .remove-product:hover {
            background: #cc0000;
        }
        
        .total-bags-highlight {
            background: #ffeb3b;
            border: 3px solid #f4b945;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .total-bags-highlight label {
            font-size: 1.1em;
            color: #f46b45;
        }
        
        .total-bags-highlight input {
            font-size: 1.2em;
            font-weight: bold;
            border: 2px solid #f46b45;
        }
        
        .add-product-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .add-product-btn:hover {
            background: #45a049;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(244, 107, 69, 0.3);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-print {
            background: #2196F3;
            color: white;
        }

        .btn-print:hover {
            background: #0b7dda;
        }
        
        .counter-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                max-height: none;
            }
            
            .no-print {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .container {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Pick List Generator</h1>
            <p>Schmidt Potato - Warehouse Picking</p>
        </div>
        
        <div class="form-container">
            <form id="pickListForm" onsubmit="handleSubmit(event)">
                
                <!-- Order Information Section -->
                <div class="section-title">üì¶ Order Information</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pickListID">Pick List ID (Auto-Generated)</label>
                        <input type="text" id="pickListID" readonly>
                        <div class="counter-info">Next: <span id="nextPickListID"></span></div>
                    </div>
                    <div class="form-group">
                        <label for="orderDate">Order Date *</label>
                        <input type="date" id="orderDate" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="customerSelect">Select Customer *</label>
                        <select id="customerSelect" required>
                            <option value="">-- Select Customer --</option>
                            <option value="sysco">Sysco Foods - Minneapolis</option>
                            <option value="usfoods">US Foods - Fargo</option>
                            <option value="gordon">Gordon Food Service - Duluth</option>
                            <option value="pfg">Performance Food Group - St. Paul</option>
                            <option value="reinhart">Reinhart Foodservice - Moorhead</option>
                            <option value="other">Other (Type Below)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="poNumber">PO Number *</label>
                        <input type="text" id="poNumber" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="shipDate">Ship Date *</label>
                        <input type="date" id="shipDate" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryDate">Delivery Date</label>
                        <input type="date" id="deliveryDate">
                    </div>
                </div>
                
                <!-- Products Section -->
                <div class="section-title">ü•î Products to Pick</div>
                
                <div id="productsContainer">
                    <!-- Product cards will be added here -->
                </div>
                
                <button type="button" class="add-product-btn" onclick="addProduct()">‚ûï Add Another Product</button>
                
                <!-- Summary Section -->
                <div class="section-title">üìä Order Summary</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalPallets">Total Pallets</label>
                        <input type="number" id="totalPallets" readonly value="0">
                    </div>
                    <div class="form-group">
                        <label for="totalBags">Total Bags</label>
                        <input type="number" id="totalBags" readonly value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalWeight">Total Weight (LBS)</label>
                        <input type="number" id="totalWeight" readonly value="0">
                    </div>
                    <div class="form-group">
                        <label for="assignedPalletIDs">Assigned Pallet IDs</label>
                        <input type="text" id="assignedPalletIDs" readonly placeholder="Will show after calculation">
                    </div>
                </div>
                
                <!-- Buttons -->
                <div class="button-group">
                    <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Reset Form</button>
                    <button type="button" class="btn-print no-print" onclick="printPickList()" id="printBtn" style="display:none;">üñ®Ô∏è Print Pick List</button>
                    <button type="submit" class="btn-primary">üì• Generate Pick List</button>
                </div>
                
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        let productCount = 0;
        let products = [];
        let lastGeneratedPickList = null;
        
        // Customer database
        const customers = {
            'sysco': 'Sysco Foods - Minneapolis',
            'usfoods': 'US Foods - Fargo',
            'gordon': 'Gordon Food Service - Duluth',
            'pfg': 'Performance Food Group - St. Paul',
            'reinhart': 'Reinhart Foodservice - Moorhead'
        };
        
        // Variety codes
        const varietyCodes = {
            'Russet Burbank': 'RB',
            'Red Pontiac': 'RP',
            'Yukon Gold': 'YG',
            'Kennebec': 'KE'
        };
        
        // Load custom varieties from localStorage
        function getCustomVarieties() {
            return JSON.parse(localStorage.getItem('customVarieties') || '[]');
        }
        
        // Build variety options HTML
        function buildVarietyOptionsHTML() {
            var html = '<option value="">Select Variety</option>' +
                '<option value="Russet Burbank">Russet Burbank</option>' +
                '<option value="Red Pontiac">Red Pontiac</option>' +
                '<option value="Yukon Gold">Yukon Gold</option>' +
                '<option value="Kennebec">Kennebec</option>';
            
            // Add custom varieties
            var customVarieties = getCustomVarieties();
            customVarieties.forEach(function(variety) {
                html += '<option value="' + variety + '">' + variety + '</option>';
            });
            
            html += '<option value="other">‚ûï Add Other Variety...</option>';
            return html;
        }
        
        // Handle variety change
        function handleVarietyChange(selectElement) {
            var productCard = selectElement.closest('.product-card');
            var customGroup = productCard.querySelector('.custom-variety-group');
            
            if (selectElement.value === 'other') {
                if (!customGroup) {
                    // Create custom variety input group
                    var customHTML = '<div class="custom-variety-group" style="margin-top: 10px;">' +
                        '<label>Enter New Variety *</label>' +
                        '<input type="text" class="custom-variety-input" placeholder="Type new variety name" style="width: calc(100% - 120px); margin-right: 10px;">' +
                        '<button type="button" class="save-variety-btn" onclick="saveCustomVariety(this)" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">üíæ Save</button>' +
                        '</div>';
                    selectElement.parentElement.insertAdjacentHTML('afterend', customHTML);
                    customGroup = productCard.querySelector('.custom-variety-group');
                }
                customGroup.style.display = 'block';
                customGroup.querySelector('.custom-variety-input').focus();
            } else if (customGroup) {
                customGroup.style.display = 'none';
            }
            
            calculateSummary();
        }
        
        // Save custom variety
        function saveCustomVariety(button) {
            var productCard = button.closest('.product-card');
            var customInput = productCard.querySelector('.custom-variety-input');
            var varietySelect = productCard.querySelector('.product-variety');
            var customGroup = productCard.querySelector('.custom-variety-group');
            var customVariety = customInput.value.trim();
            
            if (!customVariety) {
                alert('Please enter a variety name');
                return;
            }
            
            // Get existing custom varieties
            var customVarieties = getCustomVarieties();
            
            // Check if already exists
            if (customVarieties.includes(customVariety)) {
                alert('This variety already exists!');
                // Select the existing variety
                varietySelect.value = customVariety;
                customGroup.style.display = 'none';
                customInput.value = '';
                calculateSummary();
                return;
            }
            
            // Add new variety
            customVarieties.push(customVariety);
            localStorage.setItem('customVarieties', JSON.stringify(customVarieties));
            
            // Update variety code mapping (use first 2 letters as code)
            if (customVariety.length >= 2) {
                varietyCodes[customVariety] = customVariety.substring(0, 2).toUpperCase();
            } else {
                varietyCodes[customVariety] = customVariety.toUpperCase();
            }
            
            // Rebuild all variety selects in all product cards
            document.querySelectorAll('.product-variety').forEach(function(select) {
                var currentValue = select.value;
                var otherOption = select.querySelector('option[value="other"]');
                
                // Remove old custom varieties (those after Kennebec and before "other")
                var options = Array.from(select.querySelectorAll('option'));
                var kennebecIndex = options.findIndex(opt => opt.value === 'Kennebec');
                var otherIndex = options.findIndex(opt => opt.value === 'other');
                
                for (var i = kennebecIndex + 1; i < otherIndex; i++) {
                    options[i].remove();
                }
                
                // Add all custom varieties
                var allCustom = getCustomVarieties();
                allCustom.forEach(function(variety) {
                    var option = document.createElement('option');
                    option.value = variety;
                    option.textContent = variety;
                    select.insertBefore(option, otherOption);
                });
                
                // Restore selection
                if (currentValue === 'other') {
                    select.value = customVariety;
                } else {
                    select.value = currentValue;
                }
            });
            
            // Hide custom input and clear
            customGroup.style.display = 'none';
            customInput.value = '';
            
            alert('‚úÖ Variety "' + customVariety + '" saved!');
            calculateSummary();
        }
        
        // Get Pick List counter
        function getPickListCounter() {
            var counter = localStorage.getItem('pickListCounter');
            if (!counter) {
                counter = 1;
                localStorage.setItem('pickListCounter', counter);
            }
            return parseInt(counter);
        }
        
        // Set Pick List counter
        function setPickListCounter(value) {
            localStorage.setItem('pickListCounter', value);
        }
        
        // Get Pallet counter
        function getPalletCounter() {
            var counter = localStorage.getItem('palletCounter');
            if (!counter) {
                counter = 1;
                localStorage.setItem('palletCounter', counter);
            }
            return parseInt(counter);
        }
        
        // Set Pallet counter
        function setPalletCounter(value) {
            localStorage.setItem('palletCounter', value);
        }
        
        // Generate Pick List ID
        function generatePickListID() {
            var counter = getPickListCounter();
            var pickListID = 'PL-' + String(counter).padStart(3, '0');
            document.getElementById('pickListID').value = pickListID;
            
            var nextCounter = counter + 1;
            document.getElementById('nextPickListID').textContent = 'PL-' + String(nextCounter).padStart(3, '0');
        }
        
        // Handle customer selection
        document.getElementById('customerSelect').addEventListener('change', function() {
            var selected = this.value;
            if (selected && selected !== 'other' && customers[selected]) {
                document.getElementById('customerName').value = customers[selected];
            } else if (selected === 'other') {
                document.getElementById('customerName').value = '';
                document.getElementById('customerName').focus();
            }
        });
        
        // Add product
        function addProduct() {
            productCount++;
            
            var productHTML = '<div class="product-card" id="product-' + productCount + '" data-product-num="' + productCount + '">' +
                '<div class="product-header">' +
                    '<span class="product-number">Product Entry ' + productCount + '</span>' +
                    '<button type="button" class="remove-product" onclick="removeProduct(' + productCount + ')">‚úï Remove</button>' +
                '</div>' +
                '<div class="total-bags-highlight">' +
                    '<div class="form-group">' +
                        '<label>üì¶ TOTAL BAGS NEEDED *</label>' +
                        '<input type="number" class="product-total-bags" min="1" placeholder="Enter total bags" required oninput="calculateSummary()">' +
                    '</div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label>Variety *</label>' +
                        '<select class="product-variety" required onchange="handleVarietyChange(this)">' +
                            buildVarietyOptionsHTML() +
                        '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label>Pack Weight *</label>' +
                        '<select class="product-weight" required onchange="calculateSummary()">' +
                            '<option value="">Select Weight</option>' +
                            '<option value="3">3 LBS</option>' +
                            '<option value="4">4 LBS</option>' +
                            '<option value="5">5 LBS</option>' +
                            '<option value="10">10 LBS</option>' +
                            '<option value="25">25 LBS</option>' +
                            '<option value="50" selected>50 LBS</option>' +
                            '<option value="50">5/10 = 50 LBS</option>' +
                            '<option value="50">10/5 = 50 LBS</option>' +
                            '<option value="100">100 LBS</option>' +
                            '<option value="bulk">Bulk Pack</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label>Grade *</label>' +
                        '<select class="product-grade" required onchange="calculateSummary()">' +
                            '<option value="">Select Grade</option>' +
                            '<option value="Blue Tag Size A" selected>Blue Tag Size A</option>' +
                            '<option value="Blue Tag Size B">Blue Tag Size B</option>' +
                            '<option value="Red Tag Premium">Red Tag Premium</option>' +
                            '<option value="Standard">Standard</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label>Bags per Pallet (default 40)</label>' +
                        '<input type="number" class="product-bags-per-pallet" min="1" value="40" required oninput="calculateSummary()">' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            document.getElementById('productsContainer').insertAdjacentHTML('beforeend', productHTML);
            
            products.push(productCount);
            calculateSummary();
        }
        
        // Remove product
        function removeProduct(productNum) {
            var productCard = document.getElementById('product-' + productNum);
            if (productCard) {
                productCard.remove();
                var index = products.indexOf(productNum);
                if (index > -1) {
                    products.splice(index, 1);
                }
                calculateSummary();
            }
        }
        
        // Calculate summary with MIX BY WEIGHT logic
        function calculateSummary() {
            var weightGroups = {};
            
            // Step 1: Group ALL products by WEIGHT ONLY
            products.forEach(function(productNum) {
                var productCard = document.getElementById('product-' + productNum);
                if (productCard) {
                    var variety = productCard.querySelector('.product-variety').value;
                    var weight = productCard.querySelector('.product-weight').value;
                    var weightLabel = productCard.querySelector('.product-weight').selectedOptions[0].text;
                    var grade = productCard.querySelector('.product-grade').value;
                    var totalBags = parseInt(productCard.querySelector('.product-total-bags').value) || 0;
                    var bagsPerPallet = parseInt(productCard.querySelector('.product-bags-per-pallet').value) || 40;
                    
                    if (variety && weight && grade && totalBags > 0) {
                        if (!weightGroups[weight]) {
                            weightGroups[weight] = {
                                weight: weight,
                                weightLabel: weightLabel,
                                bagsPerPallet: bagsPerPallet,
                                products: []
                            };
                        }
                        
                        weightGroups[weight].products.push({
                            variety: variety,
                            grade: grade,
                            bags: totalBags,
                            weightLabel: weightLabel
                        });
                    }
                }
            });
            
            // Step 2: Calculate pallets by filling each weight group
            var currentPalletCounter = getPalletCounter();
            var totalPallets = 0;
            var totalBags = 0;
            var totalWeight = 0;
            var allPalletIDs = [];
            
            for (var weight in weightGroups) {
                var group = weightGroups[weight];
                var totalBagsInGroup = 0;
                
                group.products.forEach(function(prod) {
                    totalBagsInGroup += prod.bags;
                });
                
                var palletsNeeded = Math.ceil(totalBagsInGroup / group.bagsPerPallet);
                
                for (var i = 0; i < palletsNeeded; i++) {
                    var palletID = 'P-' + String(currentPalletCounter + totalPallets).padStart(3, '0');
                    allPalletIDs.push(palletID);
                    totalPallets++;
                }
                
                totalBags += totalBagsInGroup;
                totalWeight += (totalBagsInGroup * parseFloat(weight));
            }
            
            document.getElementById('totalPallets').value = totalPallets;
            document.getElementById('totalBags').value = totalBags;
            document.getElementById('totalWeight').value = totalWeight;
            document.getElementById('assignedPalletIDs').value = allPalletIDs.join(', ');
        }
        
        // Initialize form
        function initializeForm() {
            try {
                var today = new Date();
                var year = today.getFullYear();
                var month = String(today.getMonth() + 1).padStart(2, '0');
                var day = String(today.getDate()).padStart(2, '0');
                var dateString = year + '-' + month + '-' + day;
                
                document.getElementById('orderDate').value = dateString;
                document.getElementById('shipDate').value = dateString;
                
                generatePickListID();
                
                // Add first product automatically
                addProduct();
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }
        
        // Handle form submission
        function handleSubmit(event) {
            event.preventDefault();
            
            // Get form data
            var pickListID = document.getElementById('pickListID').value;
            var orderDate = document.getElementById('orderDate').value;
            var customerName = document.getElementById('customerName').value;
            var poNumber = document.getElementById('poNumber').value;
            var shipDate = document.getElementById('shipDate').value;
            var deliveryDate = document.getElementById('deliveryDate').value;
            
            // SMART MERGE: Group by WEIGHT ONLY (MIX varieties/grades)
            var weightGroups = {};
            
            products.forEach(function(productNum) {
                var productCard = document.getElementById('product-' + productNum);
                if (productCard) {
                    var variety = productCard.querySelector('.product-variety').value;
                    var weight = productCard.querySelector('.product-weight').value;
                    var weightLabel = productCard.querySelector('.product-weight').selectedOptions[0].text;
                    var grade = productCard.querySelector('.product-grade').value;
                    var totalBags = parseInt(productCard.querySelector('.product-total-bags').value) || 0;
                    var bagsPerPallet = parseInt(productCard.querySelector('.product-bags-per-pallet').value) || 40;
                    
                    if (variety && weight && grade && totalBags > 0) {
                        if (!weightGroups[weight]) {
                            weightGroups[weight] = {
                                weight: weight,
                                bagsPerPallet: bagsPerPallet,
                                products: []
                            };
                        }
                        
                        weightGroups[weight].products.push({
                            variety: variety,
                            grade: grade,
                            bags: totalBags,
                            weightLabel: weightLabel
                        });
                    }
                }
            });
            
            // Generate pallets from weight groups
            var currentPalletCounter = getPalletCounter();
            var palletIndex = 0;
            var allPallets = [];
            var csvData = [];
            
            // Add CSV header
            csvData.push(['Pallet ID', 'Products on Pallet', 'Total Bags', 'Total Weight (LBS)', 'Pack Weight']);
            
            // Process each weight group
            for (var weight in weightGroups) {
                var group = weightGroups[weight];
                var remainingProducts = JSON.parse(JSON.stringify(group.products));
                var bagsPerPallet = group.bagsPerPallet;
                
                while (remainingProducts.length > 0) {
                    var palletID = 'P-' + String(currentPalletCounter + palletIndex).padStart(3, '0');
                    var bagsOnPallet = 0;
                    var productsOnPallet = [];
                    
                    // Fill pallet up to bagsPerPallet
                    for (var i = 0; i < remainingProducts.length; i++) {
                        var prod = remainingProducts[i];
                        var bagsToAdd = Math.min(prod.bags, bagsPerPallet - bagsOnPallet);
                        
                        if (bagsToAdd > 0) {
                            productsOnPallet.push({
                                variety: prod.variety,
                                grade: prod.grade,
                                bags: bagsToAdd,
                                weightLabel: prod.weightLabel
                            });
                            
                            bagsOnPallet += bagsToAdd;
                            prod.bags -= bagsToAdd;
                        }
                        
                        if (bagsOnPallet >= bagsPerPallet) {
                            break;
                        }
                    }
                    
                    // Remove fully allocated products
                    remainingProducts = remainingProducts.filter(function(p) { return p.bags > 0; });
                    
                    // Create pallet data
                    var palletWeight = bagsOnPallet * parseFloat(weight);
                    var productDescription = productsOnPallet.map(function(p) {
                        return p.variety + ' ' + p.weightLabel + ' ' + p.grade + ' (' + p.bags + ')';
                    }).join('; ');
                    
                    var palletData = {
                        palletID: palletID,
                        pickListID: pickListID,
                        products: productsOnPallet,
                        totalBags: bagsOnPallet,
                        totalWeight: palletWeight,
                        packWeight: weight,
                        customerName: customerName,
                        poNumber: poNumber,
                        shipDate: shipDate
                    };
                    
                    allPallets.push(palletData);
                    csvData.push([palletID, productDescription, bagsOnPallet, palletWeight, weight + ' LBS']);
                    
                    palletIndex++;
                }
            }
            
            // Update pallet counter
            setPalletCounter(currentPalletCounter + palletIndex);
            
            // Save pick list data
            var pickListData = {
                pickListID: pickListID,
                orderDate: orderDate,
                customerName: customerName,
                poNumber: poNumber,
                shipDate: shipDate,
                deliveryDate: deliveryDate,
                totalPallets: allPallets.length,
                totalBags: parseInt(document.getElementById('totalBags').value),
                totalWeight: parseInt(document.getElementById('totalWeight').value),
                pallets: allPallets,
                generatedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            try {
                var pickLists = JSON.parse(localStorage.getItem('pickLists') || '[]');
                pickLists.push(pickListData);
                localStorage.setItem('pickLists', JSON.stringify(pickLists));
                
                lastGeneratedPickList = pickListData;
                
                // Save individual pallets
                var existingPallets = JSON.parse(localStorage.getItem('pallets') || '[]');
                allPallets.forEach(function(pallet) {
                    existingPallets.push(pallet);
                });
                localStorage.setItem('pallets', JSON.stringify(existingPallets));
            } catch (error) {
                console.error('Error saving data:', error);
            }
            
            // Increment pick list counter
            var currentPickListCounter = getPickListCounter();
            setPickListCounter(currentPickListCounter + 1);
            
            // Generate CSV export
            generateCSVExport(csvData, pickListID);
            
            // Show print button
            document.getElementById('printBtn').style.display = 'block';
            
            // Show success message
            alert('‚úÖ Pick List ' + pickListID + ' generated successfully!\n\n' +
                  'Total Pallets: ' + allPallets.length + '\n' +
                  'Total Bags: ' + pickListData.totalBags + '\n' +
                  'Total Weight: ' + pickListData.totalWeight + ' LBS\n\n' +
                  'CSV file has been downloaded.\n\n' +
                  'Click "Print Pick List" to print the warehouse copy.');
            
            return false;
        }
        
        // Generate CSV export
        function generateCSVExport(csvData, pickListID) {
            var csvContent = csvData.map(function(row) {
                return row.map(function(cell) {
                    return '"' + cell + '"';
                }).join(',');
            }).join('\n');
            
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'picklist_' + pickListID + '_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Print pick list
        function printPickList() {
            if (!lastGeneratedPickList) {
                alert('Please generate a pick list first!');
                return;
            }

            var data = lastGeneratedPickList;
            var printWindow = window.open('', '_blank');
            
            var timestamp = new Date(data.generatedAt).toLocaleString();
            
            var html = '<!DOCTYPE html><html><head><title>Pick List ' + data.pickListID + '</title>';
            html += '<style>';
            html += 'body { font-family: Arial, sans-serif; padding: 20px; }';
            html += 'h1 { text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; }';
            html += '.header-info { margin: 20px 0; border: 2px solid #000; padding: 15px; }';
            html += '.info-row { display: flex; justify-content: space-between; margin: 5px 0; }';
            html += '.pallet { border: 2px solid #000; margin: 15px 0; padding: 10px; page-break-inside: avoid; }';
            html += '.pallet-header { background: #f0f0f0; padding: 10px; font-size: 18px; font-weight: bold; }';
            html += '.product-line { margin: 8px 0; padding: 5px; border-left: 3px solid #666; padding-left: 10px; }';
            html += '.signature { margin-top: 40px; border-top: 2px solid #000; padding-top: 20px; }';
            html += '.sig-line { border-bottom: 1px solid #000; width: 300px; display: inline-block; margin: 0 10px; }';
            html += 'table { width: 100%; border-collapse: collapse; margin: 10px 0; }';
            html += 'th, td { border: 1px solid #000; padding: 8px; text-align: left; }';
            html += 'th { background: #e0e0e0; }';
            html += '@media print { .no-print { display: none; } }';
            html += '</style></head><body>';
            
            html += '<h1>ü•î SCHMIDT POTATO - PICK LIST</h1>';
            
            html += '<div class="header-info">';
            html += '<div class="info-row"><strong>Pick List ID:</strong> ' + data.pickListID + '</div>';
            html += '<div class="info-row"><strong>Customer:</strong> ' + data.customerName + '</div>';
            html += '<div class="info-row"><strong>PO Number:</strong> ' + data.poNumber + '</div>';
            html += '<div class="info-row"><strong>Ship Date:</strong> ' + data.shipDate + '</div>';
            html += '<div class="info-row"><strong>Generated:</strong> ' + timestamp + '</div>';
            html += '<div class="info-row"><strong>Total Pallets:</strong> ' + data.totalPallets + ' | <strong>Total Bags:</strong> ' + data.totalBags + ' | <strong>Total Weight:</strong> ' + data.totalWeight + ' LBS</div>';
            html += '</div>';
            
            html += '<h2>üì¶ PALLET BREAKDOWN</h2>';
            
            data.pallets.forEach(function(pallet) {
                html += '<div class="pallet">';
                html += '<div class="pallet-header">Pallet ID: ' + pallet.palletID + ' | Bags: ' + pallet.totalBags + ' | Weight: ' + pallet.totalWeight + ' LBS</div>';
                html += '<table><tr><th>Variety</th><th>Pack Weight</th><th>Grade</th><th>Bags</th></tr>';
                
                pallet.products.forEach(function(prod) {
                    html += '<tr>';
                    html += '<td>' + prod.variety + '</td>';
                    html += '<td>' + prod.weightLabel + '</td>';
                    html += '<td>' + prod.grade + '</td>';
                    html += '<td>' + prod.bags + '</td>';
                    html += '</tr>';
                });
                
                html += '</table></div>';
            });
            
            html += '<div class="signature">';
            html += '<p><strong>Picker Signature:</strong> <span class="sig-line"></span> <strong>Date:</strong> <span class="sig-line"></span></p>';
            html += '</div>';
            
            html += '<div class="no-print" style="margin-top: 20px; text-align: center;">';
            html += '<button onclick="window.print()" style="padding: 15px 30px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">üñ®Ô∏è Print</button>';
            html += '<button onclick="window.close()" style="padding: 15px 30px; font-size: 16px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">‚úï Close</button>';
            html += '</div>';
            
            html += '</body></html>';
            
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForm);
        } else {
            initializeForm();
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('pickListForm').reset();
            document.getElementById('productsContainer').innerHTML = '';
            productCount = 0;
            products = [];
            lastGeneratedPickList = null;
            document.getElementById('printBtn').style.display = 'none';
            
            var today = new Date();
            var year = today.getFullYear();
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var day = String(today.getDate()).padStart(2, '0');
            var dateString = year + '-' + month + '-' + day;
            
            document.getElementById('orderDate').value = dateString;
            document.getElementById('shipDate').value = dateString;
            
            generatePickListID();
            addProduct();
            calculateSummary();
        }
    </script>
</body>
</html>